<!DOCTYPE html>
<html lang="en">
<head>
  <title>Geothermal System</title>
  <meta charset="utf-8" />
  <meta
          content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
          name="viewport"
  />
  <link href="main.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div
        id="title"
        style="
        font-size: 40px;
        color: #1b1b1b;
        margin-top: 20px;
        font-weight: 600;
      "
>
  GEOTHERMAL DORM SYSTEM
</div>

<div class="container default" id="popup">
  <div class="popMain">
    <img id="popImg" src="Img/Home.JPG" />
    <h1 id="popHeader">Geothermal System</h1>
    <p id="popText" style="font-size: 15px">
      Welcome to our animated 3D model of Southeastern Louisiana University's Geothermal Dorm System!
    </p>
  </div>
</div>

<div class="names">
  <strong>Developers: Scott Comeaux, Logan Freeman, Joeseph Gomez, Jordan Martin</strong>
  <strong>Client: Alejandro Martinez</strong>
</div>

<style>
  body {
    margin: 0;
  }
</style>

<script type="module">
  import * as THREE from "./three.js/build/three.module.js";

  import { OrbitControls } from "./three.js/examples/jsm/controls/OrbitControls.js";
  import { GLTFLoader } from "./three.js/examples/jsm/loaders/GLTFLoader.js";
  import { RGBELoader } from "./three.js/examples/jsm/loaders/RGBELoader.js";
  import { RoughnessMipmapper } from "./three.js/examples/jsm/utils/RoughnessMipmapper.js";
  import { GUI } from "./three.js/examples/jsm/libs/dat.gui.module.js";

  let popup = document.getElementById("popup");
  let container, controls, clock, mixer;
  let ambientLight, camera, scene, renderer;
  let params = {
    showHome: showHome,
    showBoiler: showBoiler,
    showCoolingTower: showCoolingTower,
    showHeatPump: showHeatPump,
    showPipes: showPipes,
    showWell: showWell,
    rotation: true,
    winter: false,
  };
  let mesh;
  let winter;
  let particleSystem, particleCount, particles;
  init();
  createGUI();
  animate();

  function showBoiler() {
    camera.position.set(19.5, 2, -1);
    controls.target.set(19.5, 2, -4);
    controls.update();
    camera.updateProjectionMatrix();

    popup.style.display = "flex";
    document.getElementById("popImg").src = "./Img/HeatPump.jpg";
    document.getElementById("popHeader").innerHTML = "Boiler";
    document.getElementById("popText").innerHTML =
            "A heat transfer fluid, comprised of antifreeze and water, is inside the ground loop pipes. This heat transfer fluid removes heat from (heating mode) or delivers heat to (cooling mode) the earth surrounding the ground loop.";
  }

  function showCoolingTower() {
    camera.position.set(26, 3, 5);
    controls.target.set(21.3, 1, 4.7);
    controls.update();
    camera.updateProjectionMatrix();

    popup.style.display = "flex";
    document.getElementById("popImg").src =
            "./Img/CoolingTowel2.JPG";
    document.getElementById("popHeader").innerHTML = "Cooling Tower";
    document.getElementById("popText").innerHTML =
            "The Cooling Tower is a heat rejection device that rejects waste heat to the atmosphere through the cooling of a water stream to a lower temperature.";
  }

  function showHeatPump() {
    camera.position.set(26, 14, -8);
    controls.target.set(21, 12, -9.3);
    controls.update();
    camera.updateProjectionMatrix();

    popup.style.display = "flex";
    document.getElementById("popImg").src =
            "./Img/BoilerImage.JPG";
    document.getElementById("popHeader").innerHTML = "Heat Pump";
    document.getElementById("popText").innerHTML =
            "As with any heat pump, geothermal and water-source heat pumps are able to heat, cool, and, if so equipped, supply the dorm with hot water.";
  }

  function showHome() {
    camera.position.set(34, 10, 12);
    controls.target.set(15, 0, 0);
    controls.update();
    camera.updateProjectionMatrix();

    popup.style.display = "none";
  }

  function showPipes() {
    camera.position.set(12, 15, 19);
    controls.target.set(12, 0, -2);
    controls.update();
    camera.updateProjectionMatrix();

    popup.style.display = "flex";
    document.getElementById("popImg").src =
            "https://media.sciencephoto.com/t1/36/00/90/t1360090-800px-wm.jpg";
    document.getElementById("popHeader").innerHTML = "Pipes";
    document.getElementById("popText").innerHTML =
            "Heat is collected throughout the water wells and dissipated into the ground. Water returns to the dorms with a lower temperature.";
  }

  function showWell() {
    camera.position.set(8, -5, 0);
    controls.target.set(.5, -5, -2);
    controls.update();
    camera.updateProjectionMatrix();

    popup.style.display = "flex";
    document.getElementById("popImg").src = "./Img/Well.jpg";
    document.getElementById("popHeader").innerHTML = "Geothermal Well";
    document.getElementById("popText").innerHTML =
            "These are created by drilling a large hole down into the earth, usually at least 3 inches in diameter, until a specific depth is reached that can supply enough geothermal energy to heat and cool the facility it will be installed in. Our 220 wells are 300â€™ underneath the ground.";
  }

  function init() {
    container = document.createElement("div");
    document.body.appendChild(container);

    camera = new THREE.PerspectiveCamera(
            90,
            window.innerWidth / window.innerHeight,
            0.1,
            1000
    );
    camera.position.set(34, 10, 12);

    scene = new THREE.Scene();
    clock = new THREE.Clock();


    var loader = new THREE.TextureLoader();
    loader.crossOrigin = '';

    /* 3D Text Example 
    ref: https://blog.andrewray.me/creating-a-3d-font-in-three-js/
    ref2: https://threejs.org/docs/#manual/en/introduction/Creating-text
    */
  
    // var material = new THREE.MeshPhongMaterial({
    //     color: 0xdddddd
    // });

    // var fontLoader = new THREE.FontLoader();

    // fontLoader.load( 'fonts/helvetiker_regular.typeface.json', function ( font ) {
    //   var textGeom = new THREE.TextGeometry( 'temp example', {
    //     font: font,
    //     size: 80,
    //     height: 5,
    //     curveSegments: 12,
    //     bevelEnabled: true,
    //     bevelThickness: 10,
    //     bevelSize: 8,
    //     bevelOffset: 0,
    //     bevelSegments: 5
    //   } );
    //   //Move outside load function
    //   var textMesh = new THREE.Mesh( textGeom, material );
    //   scene.add( textMesh );
    // } );

    // // Do some optional calculations. This is only if you need to get the
    // // width of the generated text
    // textGeom.computeBoundingBox();
    // textGeom.textWidth = textGeom.boundingBox.max.x - textGeom.boundingBox.min.x;

    /* End of 3D Text Example */

    ///////////////////
    // SNOW  //
    ///////////////////
    particleCount = 10000;
    let pMaterial = new THREE.PointCloudMaterial({
      color: 0xFFFFFF,
      size: 1,
      map: loader.load(
              "https://s3-us-west-2.amazonaws.com/s.cdpn.io/212131/snow-small.png"
      ),
      blending: THREE.AdditiveBlending,
      depthTest: false,
      transparent: true
    });

    particles = new THREE.Geometry;
    for (var i = 0; i < particleCount; i++) {
      var pX = Math.random()*500 - 250,
              pY = Math.random()*500 - 250,
              pZ = Math.random()*500 - 250,
              particle = new THREE.Vector3(pX, pY, pZ);
      particle.velocity = {};
      particle.velocity.y = 0;
      particles.vertices.push(particle);
    }
    particleSystem = new THREE.PointCloud(particles, pMaterial);

    new RGBELoader()
            .setDataType(THREE.UnsignedByteType)
            .setPath("Img/")
            .load("Gradient.hdr", function (texture) {
              let envMap = pmremGenerator.fromEquirectangular(texture).texture;

              scene.background = envMap;
              scene.environment = envMap;

              texture.dispose();
              pmremGenerator.dispose();
              render();

              let roughnessMipmapper = new RoughnessMipmapper(renderer);

              let loader = new GLTFLoader().setPath("Models/");
              loader.load("main.glb", function (gltf) {
                let model = gltf
                let animations = gltf.animations;

                mixer = new THREE.AnimationMixer( gltf.scene );
                animations.forEach(function (clip) {
                    mixer.clipAction(clip).play();
                });

                model.scene.traverse(function (child) {
                  console.log(child);
                  if (child.isMesh) {
                      
                  }
                });
                scene.add(model.scene);
                roughnessMipmapper.dispose();
                render();
              });
            });

    ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambientLight);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1;
    renderer.outputEncoding = THREE.sRGBEncoding;
    container.appendChild(renderer.domElement);

    controls = new OrbitControls(camera, renderer.domElement);
    controls.addEventListener("change", render); // use if there is no animation loop
    controls.minDistance = 2;
    controls.maxDistance = 60;
    controls.target.set(15, 0, 0);
    controls.autoRotate = true;
    controls.autoRotateSpeed = 1.5;
    controls.update();

    let pmremGenerator = new THREE.PMREMGenerator(renderer);
    pmremGenerator.compileEquirectangularShader();

    window.addEventListener("resize", onWindowResize, false);
  }
  function simulateRain() {
    let pCount = particleCount;
    while (pCount--) {
      let particle = particles.vertices[pCount];
      if (particle.y < -200) {
        particle.y = 200;
        particle.velocity.y = 0;
      }
      particle.velocity.y -= Math.random() * .002;
      particle.y += particle.velocity.y;
    }
    particles.verticesNeedUpdate = true;
    
  }

  function createGUI() {
    let gui = new GUI({ name: "Damp setting" });
    gui.add(params, "showHome").name("Home View");
    gui.add(params, "showBoiler").name("Boiler");
    gui.add(params, "showCoolingTower").name("Cooling Tower");
    gui.add(params, "showHeatPump").name("Heat Pump");
    gui.add(params, "showPipes").name("Pipes");
    gui.add(params, "showWell").name("Geothermal Well");
    gui
            .add(params, "rotation")
            .name("Rotation")
            .onChange(function (val) {
              controls.autoRotate = val === true;
            });
    gui
            .add(params, "winter")
            .name("Winter")
            .onChange(function (val) {
              if (val === true){
                scene.add(particleSystem);
              }
              else{
                scene.remove(particleSystem);
              }
            });
    window.addEventListener("resize", onWindowResize, false);
  }

  function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
    render();
  }

  function animate() {
    requestAnimationFrame(animate);
    simulateRain();
    controls.update();
    render();
  }

  function render() {
    let delta = clock.getDelta();

    if ( mixer !== undefined ) {

      mixer.update( delta );

    }
    renderer.render(scene, camera);
  }
</script>
</body>
</html>
